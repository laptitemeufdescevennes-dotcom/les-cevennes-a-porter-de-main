const MAPBOX_TOKEN=(window.MAPBOX_TOKEN||'').trim();mapboxgl.accessToken=MAPBOX_TOKEN||'pk.example._dummy';const map=new mapboxgl.Map({container:'map',style:'mapbox://styles/mapbox/outdoors-v12',center:[3.7,44.1],zoom:8.2,hash:true});map.addControl(new mapboxgl.NavigationControl(),'top-right');async function gj(u){const r=await fetch(u);return r.json()}const lines=[['rivieres','#3b82f6',2,false],['routes','#f59e0b',2,true],['sentiers_gr','#10b981',2,false]];const areas=[['zone_coeur','#16a34a'],['zone_adhesion','#f97316'],['zone_piemonts_pnc','#2563eb'],['epci_piemont_ensemble','#64748b'],['epci_ales_agglo','#22c55e'],['epci_ca_causses_aigoual_cevennes','#a855f7'],['epci_cc_cevennes_gangeoises','#06b6d4'],['zones_sensibles','#ef4444']];const pois=['villes','villages','towns','hameaux','offices_tourisme','cols_sommets','cascades','panoramas','sites_historiques','sites_naturels','lieux_insolites','activites','commerces'];map.on('load',async()=>{for(const [k,c] of areas){const d=await gj('./data/'+k+'.geojson');map.addSource(k,{type:'geojson',data:d});map.addLayer({id:k+'-fill',type:'fill',source:k,paint:{'fill-color':c,'fill-opacity':0.18}});map.addLayer({id:k+'-line',type:'line',source:k,paint:{'line-color':c,'line-width':1.2}})}for(const [k,c,w,dsh] of lines){const d=await gj('./data/'+k+'.geojson');map.addSource(k,{type:'geojson',data:d});map.addLayer({id:k+'-line',type:'line',source:k,paint:{'line-color':c,'line-width':w,'line-dasharray':dsh?[2,2]:[1,0]}})}for(const key of pois){const d=await gj('./data/poi_'+key+'.geojson');const sid='poi_'+key;map.addSource(sid,{type:'geojson',data:d,cluster:true,clusterMaxZoom:12,clusterRadius:40});map.loadImage('./assets/icons/'+key.replace('cols_sommets','cols_sommets')+'.svg',(e,img)=>{if(!e&&img)map.addImage('icon_'+key,img)});map.addLayer({id:sid+'-clusters',type:'circle',source:sid,filter:['has','point_count'],paint:{'circle-radius':['step',['get','point_count'],18,10,22,30,28],'circle-color':['step',['get','point_count'],'#86efac',10,'#60a5fa',30,'#fbbf24'],'circle-stroke-color':'#0b1220','circle-stroke-width':1}});map.addLayer({id:sid+'-count',type:'symbol',source:sid,filter:['has','point_count'],layout:{'text-field':['get','point_count_abbreviated'],'text-size':12},paint:{'text-color':'#0b1220'}});map.addLayer({id:sid+'-pts',type:'symbol',source:sid,filter:['!',['has','point_count']],layout:{'icon-image':'icon_'+key,'icon-size':0.9,'text-field':['get','name'],'text-offset':[0,1.2],'text-size':12},paint:{'text-halo-color':'#0b1220','text-halo-width':0.6,'text-color':'#e5e7eb'}})}});